<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PWA Debug - STC IISER TVM</title>
    <link rel="manifest" href="site.webmanifest">
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .debug-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.warning { background: #fff3cd; color: #856404; }
        .status.error { background: #f8d7da; color: #721c24; }
        .install-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        .install-btn:hover { background: #0056b3; }
        pre { background: #f8f9fa; padding: 15px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üîß PWA Debug Tool</h1>
    <p>This page helps debug PWA installation issues.</p>

    <div class="debug-section">
        <h2>PWA Readiness Check</h2>
        <div id="readiness-results">Checking...</div>
    </div>

    <div class="debug-section">
        <h2>Install Options</h2>
        <button class="install-btn" onclick="attemptInstall()">üöÄ Try Native Install</button>
        <button class="install-btn" onclick="attemptOpenInApp()">üì± Open in App</button>
        <button class="install-btn" onclick="showManualInstructions()">üìñ Manual Instructions</button>
        <button class="install-btn" onclick="checkManifest()">üìã Check Manifest</button>
        <button class="install-btn" onclick="checkServiceWorker()">‚öôÔ∏è Check Service Worker</button>
        <button class="install-btn" onclick="resetAppInstallStatus()">üîÑ Reset Install Status</button>
        <button class="install-btn" onclick="simulateAppInstalled()">üéØ Simulate App Installed</button>
        <button class="install-btn" onclick="validatePWA()">üîç Validate PWA</button>
        <button class="install-btn" onclick="showDeploymentChecklist()">üìã Deployment Checklist</button>
    </div>

    <div class="debug-section">
        <h2>Browser Information</h2>
        <div id="browser-info"></div>
    </div>

    <div class="debug-section">
        <h2>Console Logs</h2>
        <pre id="console-logs"></pre>
    </div>

    <div class="debug-section">
        <h2>Real-time Status</h2>
        <div id="install-status">Waiting for install prompt...</div>
    </div>

    <script>
        let deferredPrompt = null;
        let logs = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            logs.push(logEntry);
            console.log(message);
            updateConsole();
        }

        function updateConsole() {
            document.getElementById('console-logs').textContent = logs.slice(-10).join('\n');
        }

        function checkPWAReadiness() {
            const results = document.getElementById('readiness-results');
            let html = '';

            // Service Worker
            if ('serviceWorker' in navigator) {
                html += '<div class="status success">‚úÖ Service Worker supported</div>';
            } else {
                html += '<div class="status error">‚ùå Service Worker not supported</div>';
            }

            // Manifest
            const manifestLink = document.querySelector('link[rel="manifest"]');
            if (manifestLink) {
                html += '<div class="status success">‚úÖ Manifest link found</div>';
            } else {
                html += '<div class="status error">‚ùå Manifest link not found</div>';
            }

            // HTTPS
            if (location.protocol === 'https:' || location.hostname === 'localhost') {
                html += '<div class="status success">‚úÖ HTTPS requirement met</div>';
            } else {
                html += '<div class="status error">‚ùå HTTPS required</div>';
            }

            // Browser support
            const isChrome = /Chrome/.test(navigator.userAgent) && /Google Inc/.test(navigator.vendor);
            const isEdge = /Edg/.test(navigator.userAgent);
            
            if (isChrome || isEdge) {
                html += '<div class="status success">‚úÖ Install prompt supported browser</div>';
            } else {
                html += '<div class="status warning">‚ö†Ô∏è Limited install prompt support</div>';
            }

            // App install status
            const isInstalled = localStorage.getItem('pwa-installed') === 'true';
            const isStandalone = window.navigator.standalone || window.matchMedia('(display-mode: standalone)').matches;
            
            if (isStandalone) {
                html += '<div class="status success">‚úÖ Running in standalone mode (installed)</div>';
            } else if (isInstalled) {
                html += '<div class="status warning">‚ö†Ô∏è App marked as installed but running in browser</div>';
            } else {
                html += '<div class="status error">‚ùå App not installed</div>';
            }

            results.innerHTML = html;
        }

        function displayBrowserInfo() {
            const info = document.getElementById('browser-info');
            info.innerHTML = `
                <strong>User Agent:</strong> ${navigator.userAgent}<br>
                <strong>Platform:</strong> ${navigator.platform}<br>
                <strong>Protocol:</strong> ${location.protocol}<br>
                <strong>Host:</strong> ${location.host}<br>
                <strong>Standalone Mode:</strong> ${window.navigator.standalone || window.matchMedia('(display-mode: standalone)').matches}
            `;
        }

        async function checkManifest() {
            try {
                const response = await fetch('site.webmanifest');
                const manifest = await response.json();
                log('Manifest loaded successfully');
                log(JSON.stringify(manifest, null, 2));
                
                // Check required fields
                const required = ['name', 'start_url', 'display', 'icons'];
                const missing = required.filter(field => !manifest[field]);
                
                if (missing.length === 0) {
                    log('‚úÖ Manifest has all required fields', 'success');
                } else {
                    log(`‚ùå Manifest missing: ${missing.join(', ')}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Failed to load manifest: ${error.message}`, 'error');
            }
        }

        async function checkServiceWorker() {
            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.register('/sw.js');
                    log('‚úÖ Service Worker registered successfully');
                    log(`SW State: ${registration.active ? 'active' : 'not active'}`);
                    
                    registration.addEventListener('updatefound', () => {
                        log('üîÑ Service Worker update found');
                    });
                } catch (error) {
                    log(`‚ùå Service Worker registration failed: ${error.message}`, 'error');
                }
            } else {
                log('‚ùå Service Worker not supported', 'error');
            }
        }

        function attemptInstall() {
            if (deferredPrompt) {
                log('üöÄ Triggering install prompt');
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    log(`User choice: ${choiceResult.outcome}`);
                    deferredPrompt = null;
                });
            } else {
                log('‚ùå No install prompt available');
                showManualInstructions();
            }
        }

        function attemptOpenInApp() {
            if (window.pwaInstaller) {
                log('üì± Testing Open in App functionality');
                window.pwaInstaller.openInApp();
            } else {
                log('‚ùå PWA Installer not available');
            }
        }

        function resetAppInstallStatus() {
            localStorage.removeItem('pwa-installed');
            log('üîÑ Cleared PWA install status from localStorage');
            
            if (window.pwaInstaller) {
                window.pwaInstaller.isInstalled = false;
                window.pwaInstaller.showOpenInAppOption = false;
                log('üîÑ Reset PWA installer status');
            }
            
            // Refresh the page to see changes
            setTimeout(() => {
                log('üîÑ Refreshing page to reflect changes...');
                location.reload();
            }, 2000);
        }

        function simulateAppInstalled() {
            localStorage.setItem('pwa-installed', 'true');
            log('üéØ Simulated app installation - marked in localStorage');
            
            if (window.pwaInstaller) {
                window.pwaInstaller.isInstalled = true;
                window.pwaInstaller.showOpenInAppOption = true;
                log('üéØ Updated PWA installer to show Open in App option');
                
                // Hide install button and show open app button
                const installBtn = document.getElementById('pwa-install-button');
                if (installBtn) {
                    installBtn.remove();
                }
                window.pwaInstaller.showInstallButton();
            }
            
            // Refresh readiness check
            setTimeout(() => {
                checkPWAReadiness();
                log('‚úÖ App simulation complete - should now show "Open in App" option');
            }, 1000);
        }

        async function validatePWA() {
            log('üîç Starting comprehensive PWA validation...');
            
            if (!window.PWAValidator) {
                log('‚ùå PWA Validator not loaded');
                return;
            }
            
            const validator = new window.PWAValidator();
            const results = await validator.validatePWA();
            
            log(`üìä Validation complete: ${results.isValid ? 'VALID' : 'HAS ISSUES'}`);
            log(`   Issues: ${results.issues.length}, Warnings: ${results.warnings.length}, Successes: ${results.successes.length}`);
            
            if (results.issues.length > 0) {
                log('‚ùå Critical Issues Found:');
                results.issues.forEach(issue => log(`   ‚Ä¢ ${issue}`));
            }
            
            if (results.warnings.length > 0) {
                log('‚ö†Ô∏è Warnings:');
                results.warnings.forEach(warning => log(`   ‚Ä¢ ${warning}`));
            }
        }

        function showDeploymentChecklist() {
            if (!window.PWAValidator) {
                log('‚ùå PWA Validator not loaded');
                return;
            }
            
            const validator = new window.PWAValidator();
            validator.generateDeploymentChecklist();
            log('üìã Deployment checklist shown in console');
        }

        function showManualInstructions() {
            const isChrome = /Chrome/.test(navigator.userAgent) && /Google Inc/.test(navigator.vendor);
            
            if (isChrome) {
                alert(`Chrome Desktop Installation:
1. Look for the install icon (+) in the address bar
2. Or use menu ‚Üí "Install STC IISER TVM..."
3. Click "Install" in the popup

If you don't see the install option:
- Try refreshing the page
- Visit the site more frequently
- Check that all PWA requirements are met`);
            } else {
                alert('Install instructions vary by browser. Check your browser\'s menu for "Install" or "Add to Home Screen" options.');
            }
        }

        // Listen for install prompt
        window.addEventListener('beforeinstallprompt', (e) => {
            log('üéâ Install prompt available!');
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('install-status').innerHTML = 
                '<div class="status success">‚úÖ Install prompt available! Click "Try Native Install" button.</div>';
        });

        window.addEventListener('appinstalled', () => {
            log('üéä App installed successfully!');
            document.getElementById('install-status').innerHTML = 
                '<div class="status success">üéä App installed successfully!</div>';
        });

        // Initialize
        window.addEventListener('load', () => {
            checkPWAReadiness();
            displayBrowserInfo();
            checkServiceWorker();
            checkManifest();
            log('PWA Debug page loaded');
        });

        // Log user interactions
        document.addEventListener('click', () => {
            log('üëÜ User interaction detected');
        }, { once: true });
    </script>
    
    <!-- PWA Configuration -->
    <script src="js/pwa-config.js"></script>
    <!-- PWA Validator -->
    <script src="js/pwa-validator.js"></script>
</body>
</html>
